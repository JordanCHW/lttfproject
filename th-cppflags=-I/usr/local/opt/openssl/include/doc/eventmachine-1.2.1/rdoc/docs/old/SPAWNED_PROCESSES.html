<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
  <meta content="text/html; charset=UTF-8" http-equiv="Content-Type" />

  <title>File: SPAWNED_PROCESSES [eventmachine-1.2.1 Documentation]</title>

  <link type="text/css" media="screen" href="../../rdoc.css" rel="stylesheet" />

  <script src="../../js/jquery.js" type="text/javascript"
    charset="utf-8"></script>
  <script src="../../js/thickbox-compressed.js" type="text/javascript"
    charset="utf-8"></script>
  <script src="../../js/quicksearch.js" type="text/javascript"
    charset="utf-8"></script>
  <script src="../../js/darkfish.js" type="text/javascript"
    charset="utf-8"></script>
</head>

<body class="file">
  <div id="metadata">
    <div id="home-metadata">
      <div id="home-section" class="section">
        <h3 class="section-header">
          <a href="../../index.html">Home</a>
          <a href="../../index.html#classes">Classes</a>
          <a href="../../index.html#methods">Methods</a>
        </h3>
      </div>
    </div>

    <div id="project-metadata">
      
      
      <div id="fileindex-section" class="section project-section">
        <h3 class="section-header">Files</h3>
        <ul>
        
          <li class="file"><a href="../../docs/old/ChangeLog.html">ChangeLog</a></li>
        
          <li class="file"><a href="../../docs/old/DEFERRABLES.html">DEFERRABLES</a></li>
        
          <li class="file"><a href="../../docs/old/EPOLL.html">EPOLL</a></li>
        
          <li class="file"><a href="../../docs/old/INSTALL.html">INSTALL</a></li>
        
          <li class="file"><a href="../../docs/old/KEYBOARD.html">KEYBOARD</a></li>
        
          <li class="file"><a href="../../docs/old/LEGAL.html">LEGAL</a></li>
        
          <li class="file"><a href="../../docs/old/LIGHTWEIGHT_CONCURRENCY.html">LIGHTWEIGHT_CONCURRENCY</a></li>
        
          <li class="file"><a href="../../docs/old/PURE_RUBY.html">PURE_RUBY</a></li>
        
          <li class="file"><a href="../../docs/old/RELEASE_NOTES.html">RELEASE_NOTES</a></li>
        
          <li class="file"><a href="../../docs/old/SMTP.html">SMTP</a></li>
        
          <li class="file"><a href="../../docs/old/SPAWNED_PROCESSES.html">SPAWNED_PROCESSES</a></li>
        
          <li class="file"><a href="../../docs/old/TODO.html">TODO</a></li>
        
        </ul>
      </div>
      

      <div id="classindex-section" class="section project-section">
        <h3 class="section-header">Class Index
          <span class="search-toggle"><img src="../../images/find.png"
            height="16" width="16" alt="[+]"
            title="show/hide quicksearch" /></span></h3>
        <form action="#" method="get" accept-charset="utf-8" class="initially-hidden">
        <fieldset>
          <legend>Quicksearch</legend>
          <input type="text" name="quicksearch" value=""
            class="quicksearch-field" />
        </fieldset>
        </form>

        <ul class="link-list">
        
          <li><a href="../../EventMachine.html">EventMachine</a></li>
        
          <li><a href="../../EventMachine.html">EventMachine</a></li>
        
          <li><a href="../../EventMachine/CertificateCreator.html">EventMachine::CertificateCreator</a></li>
        
          <li><a href="../../EventMachine/Channel.html">EventMachine::Channel</a></li>
        
          <li><a href="../../EventMachine/Completion.html">EventMachine::Completion</a></li>
        
          <li><a href="../../EventMachine/Connection.html">EventMachine::Connection</a></li>
        
          <li><a href="../../EventMachine/ConnectionError.html">EventMachine::ConnectionError</a></li>
        
          <li><a href="../../EventMachine/ConnectionNotBound.html">EventMachine::ConnectionNotBound</a></li>
        
          <li><a href="../../EventMachine/DNS.html">EventMachine::DNS</a></li>
        
          <li><a href="../../EventMachine/DNS/Request.html">EventMachine::DNS::Request</a></li>
        
          <li><a href="../../EventMachine/DNS/RequestIdAlreadyUsed.html">EventMachine::DNS::RequestIdAlreadyUsed</a></li>
        
          <li><a href="../../EventMachine/DNS/Resolver.html">EventMachine::DNS::Resolver</a></li>
        
          <li><a href="../../EventMachine/DNS/Socket.html">EventMachine::DNS::Socket</a></li>
        
          <li><a href="../../EventMachine/DatagramObject.html">EventMachine::DatagramObject</a></li>
        
          <li><a href="../../EventMachine/DefaultDeferrable.html">EventMachine::DefaultDeferrable</a></li>
        
          <li><a href="../../EventMachine/Deferrable.html">EventMachine::Deferrable</a></li>
        
          <li><a href="../../EventMachine/DeferrableChildProcess.html">EventMachine::DeferrableChildProcess</a></li>
        
          <li><a href="../../EventMachine/Error.html">EventMachine::Error</a></li>
        
          <li><a href="../../EventMachine/EvmaKeyboard.html">EventMachine::EvmaKeyboard</a></li>
        
          <li><a href="../../EventMachine/EvmaTCPClient.html">EventMachine::EvmaTCPClient</a></li>
        
          <li><a href="../../EventMachine/EvmaTCPServer.html">EventMachine::EvmaTCPServer</a></li>
        
          <li><a href="../../EventMachine/EvmaUDPSocket.html">EventMachine::EvmaUDPSocket</a></li>
        
          <li><a href="../../EventMachine/EvmaUNIXClient.html">EventMachine::EvmaUNIXClient</a></li>
        
          <li><a href="../../EventMachine/EvmaUNIXServer.html">EventMachine::EvmaUNIXServer</a></li>
        
          <li><a href="../../EventMachine/FileNotFoundException.html">EventMachine::FileNotFoundException</a></li>
        
          <li><a href="../../EventMachine/FileStreamer.html">EventMachine::FileStreamer</a></li>
        
          <li><a href="../../EventMachine/FileWatch.html">EventMachine::FileWatch</a></li>
        
          <li><a href="../../EventMachine/Iterator.html">EventMachine::Iterator</a></li>
        
          <li><a href="../../EventMachine/LoopbreakReader.html">EventMachine::LoopbreakReader</a></li>
        
          <li><a href="../../EventMachine/PeriodicTimer.html">EventMachine::PeriodicTimer</a></li>
        
          <li><a href="../../EventMachine/Pool.html">EventMachine::Pool</a></li>
        
          <li><a href="../../EventMachine/ProcessWatch.html">EventMachine::ProcessWatch</a></li>
        
          <li><a href="../../EventMachine/Protocols.html">EventMachine::Protocols</a></li>
        
          <li><a href="../../EventMachine/Protocols.html">EventMachine::Protocols</a></li>
        
          <li><a href="../../EventMachine/Protocols/HeaderAndContentProtocol.html">EventMachine::Protocols::HeaderAndContentProtocol</a></li>
        
          <li><a href="../../EventMachine/Protocols/HttpClient.html">EventMachine::Protocols::HttpClient</a></li>
        
          <li><a href="../../EventMachine/Protocols/HttpClient2.html">EventMachine::Protocols::HttpClient2</a></li>
        
          <li><a href="../../EventMachine/Protocols/HttpClient2/Request.html">EventMachine::Protocols::HttpClient2::Request</a></li>
        
          <li><a href="../../EventMachine/Protocols/LineAndTextProtocol.html">EventMachine::Protocols::LineAndTextProtocol</a></li>
        
          <li><a href="../../EventMachine/Protocols/LineProtocol.html">EventMachine::Protocols::LineProtocol</a></li>
        
          <li><a href="../../EventMachine/Protocols/LineText2.html">EventMachine::Protocols::LineText2</a></li>
        
          <li><a href="../../EventMachine/Protocols/Memcache.html">EventMachine::Protocols::Memcache</a></li>
        
          <li><a href="../../EventMachine/Protocols/Memcache/ParserError.html">EventMachine::Protocols::Memcache::ParserError</a></li>
        
          <li><a href="../../EventMachine/Protocols/ObjectProtocol.html">EventMachine::Protocols::ObjectProtocol</a></li>
        
          <li><a href="../../EventMachine/Protocols/Postgres3.html">EventMachine::Protocols::Postgres3</a></li>
        
          <li><a href="../../EventMachine/Protocols/SASLauth.html">EventMachine::Protocols::SASLauth</a></li>
        
          <li><a href="../../EventMachine/Protocols/SASLauthclient.html">EventMachine::Protocols::SASLauthclient</a></li>
        
          <li><a href="../../EventMachine/Protocols/SmtpClient.html">EventMachine::Protocols::SmtpClient</a></li>
        
          <li><a href="../../EventMachine/Protocols/SmtpServer.html">EventMachine::Protocols::SmtpServer</a></li>
        
          <li><a href="../../EventMachine/Protocols/Socks4.html">EventMachine::Protocols::Socks4</a></li>
        
          <li><a href="../../EventMachine/Protocols/Stomp.html">EventMachine::Protocols::Stomp</a></li>
        
          <li><a href="../../EventMachine/Protocols/Stomp/Message.html">EventMachine::Protocols::Stomp::Message</a></li>
        
          <li><a href="../../EventMachine/Protocols/TcpConnectTester.html">EventMachine::Protocols::TcpConnectTester</a></li>
        
          <li><a href="../../EventMachine/Queue.html">EventMachine::Queue</a></li>
        
          <li><a href="../../EventMachine/Reactor.html">EventMachine::Reactor</a></li>
        
          <li><a href="../../EventMachine/Selectable.html">EventMachine::Selectable</a></li>
        
          <li><a href="../../EventMachine/SpawnedProcess.html">EventMachine::SpawnedProcess</a></li>
        
          <li><a href="../../EventMachine/StreamObject.html">EventMachine::StreamObject</a></li>
        
          <li><a href="../../EventMachine/SystemCmd.html">EventMachine::SystemCmd</a></li>
        
          <li><a href="../../EventMachine/ThreadedResource.html">EventMachine::ThreadedResource</a></li>
        
          <li><a href="../../EventMachine/TickLoop.html">EventMachine::TickLoop</a></li>
        
          <li><a href="../../EventMachine/Timer.html">EventMachine::Timer</a></li>
        
          <li><a href="../../EventMachine/UnknownTimerFired.html">EventMachine::UnknownTimerFired</a></li>
        
          <li><a href="../../EventMachine/Unsupported.html">EventMachine::Unsupported</a></li>
        
          <li><a href="../../EventMachine/UuidGenerator.html">EventMachine::UuidGenerator</a></li>
        
          <li><a href="../../EventMachine/YieldBlockFromSpawnedProcess.html">EventMachine::YieldBlockFromSpawnedProcess</a></li>
        
          <li><a href="../../Object.html">Object</a></li>
        
          <li><a href="../../EventMachine.html">Object::EM</a></li>
        
          <li><a href="../../EventMachine/Protocols.html">Object::P</a></li>
        
          <li><a href="../../BufferedTokenizer.html">BufferedTokenizer</a></li>
        
          <li><a href="../../IO.html">IO</a></li>
        
          <li><a href="../../StringIO.html">StringIO</a></li>
        
          <li><a href="../../TestConnection.html">TestConnection</a></li>
        
        </ul>
        <div id="no-class-search-results" style="display: none;">No matching classes.</div>
      </div>

      
    </div>
  </div>

  <div id="documentation">
    
<p><a href="../../EventMachine.html">EventMachine</a> (<a
href="../../EventMachine.html">EM</a>) adds two different formalisms for
lightweight concurrency to the Ruby programmer's toolbox: spawned processes
and deferrables. This note will show you how to use spawned processes. For
more information, see the separate document LIGHTWEIGHT_CONCURRENCY.</p>

<h3>What are Spawned Processes?</h3>

<p>Spawned Processes in <a href="../../EventMachine.html">EventMachine</a> are
inspired directly by the “processes” found in the Erlang programming
language. <a href="../../EventMachine.html">EM</a> deliberately borrows
much (but not all) of Erlang’s terminology. However, EM’s spawned processes
differ from Erlang’s in ways that reflect not only Ruby style, but also the
fact that Ruby is not a functional language like Erlang.</p>

<p>Let’s proceed with a complete, working code sample that we will analyze
line by line. Here’s an <a href="../../EventMachine.html">EM</a>
implementation of the “ping-pong” program that also appears in the Erlang
tutorial:</p>

<pre>require 'eventmachine'

EM.run {
  pong = EM.spawn {|x, ping|
    puts &quot;Pong received #{x}&quot;
    ping.notify( x-1 )
  }

  ping = EM.spawn {|x|
    if x &gt; 0
      puts &quot;Pinging #{x}&quot;
      pong.notify x, self
    else
      EM.stop
    end
  }

  ping.notify 3
}</pre>

<p>If you run this program, you’ll see the following output:</p>

<pre>Pinging 3
Pong received 3
Pinging 2
Pong received 2
Pinging 1
Pong received 1</pre>

<p>Let’s take it step by step.</p>

<p>EventMachine#spawn works very much like the built-in function spawn in
Erlang. It returns a reference to a Ruby object of class <a
href="../../EventMachine/SpawnedProcess.html">EventMachine::SpawnedProcess</a>,
which is actually a schedulable entity. In Erlang, the value returned from
spawn is called a “process identifier” or “pid.” But we’ll refer to the
Ruby object returned from EM#spawn simply as a “spawned process.”</p>

<p>You pass a Ruby block with zero or more parameters to EventMachine#spawn.
Like all Ruby blocks, this one is a closure, so it can refer to variables
defined in the local context when you call EM#spawn.</p>

<p>However, the code block passed to EM#spawn does NOT execute immediately by
default. Rather, it will execute only when the Spawned <a
href="../../Object.html">Object</a> is “notified.” In Erlang, this process
is called “message passing,” and is done with the operator !, but in Ruby
it’s done simply by calling the notify method of a spawned-process object.
The parameters you pass to notify must match those defined in the block
that was originally passed to EM#spawn.</p>

<p>When you call the notify method of a spawned-process object, EM’s reactor
core will execute the code block originally passed to EM#spawn, at some
point in the future. (notify itself merely adds a notification to the
object’s message queue and ALWAYS returns immediately.)</p>

<p>When a SpawnedProcess object executes a notification, it does so in the
context of the SpawnedProcess object itself. The notified code block can
see local context from the point at which EM#spawn was called. However, the
value of “self” inside the notified code block is a reference to the
SpawnedProcesss object itself.</p>

<p>An <a href="../../EventMachine.html">EM</a> spawned process is nothing more
than a Ruby object with a message queue attached to it. You can have any
number of spawned processes in your program without compromising
scalability. You can notify a spawned process any number of times, and each
notification will cause a “message” to be placed in the queue of the
spawned process. Spawned processes with non-empty message queues are
scheduled for execution automatically by the <a
href="../../EventMachine.html">EM</a> reactor. Spawned processes with no
visible references are garbage-collected like any other Ruby object.</p>

<p>Back to our code sample:</p>

<pre>pong = EM.spawn {|x, ping|
  puts &quot;Pong received #{x}&quot;
  ping.notify( x-1 )
}</pre>

<p>This simply creates a spawned process and assigns it to the local variable
pong. You can see that the spawned code block takes a numeric parameter and
a reference to another spawned process. When pong is notified, it expects
to receive arguments corresponding to these two parameters. It simply
prints out the number it receives as the first argument. Then it notifies
the spawned process referenced by the second argument, passing it the first
argument minus 1.</p>

<p>And then the block ends, which is crucial because otherwise nothing else
can run. (Remember that in LC, scheduled entities run to completion and are
never preempted.)</p>

<p>On to the next bit of the code sample:</p>

<pre>ping = EM.spawn {|x|
  if x &gt; 0
    puts &quot;Pinging #{x}&quot;
    pong.notify x, self
  else
    EM.stop
  end
}</pre>

<p>Here, we’re spawning a process that takes a single (numeric) parameter. If
the parameter is greater than zero, the block writes it to the console. It
then notifies the spawned process referenced by the pong local variable,
passing as arguments its number argument, and a reference to itself. The
latter reference, as you saw above, is used by pong to send a return
notification.</p>

<p>If the ping process receives a zero value, it will stop the reactor loop
and end the program.</p>

<p>Now we’ve created a pair of spawned processes, but nothing else has
happened. If we stop now, the program will spin in the <a
href="../../EventMachine.html">EM</a> reactor loop, doing nothing at all.
Our spawned processes will never be scheduled for execution.</p>

<p>But look at the next line in the code sample:</p>

<pre>ping.notify 3</pre>

<p>This line gets the ping-pong ball rolling. We call ping’s notify method,
passing the argument 3. This causes a message to be sent to the ping
spawned process. The message contains the single argument, and it causes
the <a href="../../EventMachine.html">EM</a> reactor to schedule the ping
process. And this in turn results in the execution of the Ruby code block
passed to EM#spawn when ping was created. Everything else proceeds as a
result of the messages that are subsequently passed to each other by the
spawned processes.</p>

<p>[TODO, present the outbound network i/o use case, and clarify that spawned
processes are interleaved with normal i/o operations and don’t interfere
with them at all. Also, blame Erlang for the confusing term “process”]</p>

  </div>

  <div id="validator-badges">
    <p><small><a href="http://validator.w3.org/check/referer">[Validate]</a></small></p>
    <p><small>Generated with the <a href="http://deveiate.org/projects/Darkfish-Rdoc/">Darkfish
      Rdoc Generator</a> 2</small>.</p>
  </div>
</body>
</html>

