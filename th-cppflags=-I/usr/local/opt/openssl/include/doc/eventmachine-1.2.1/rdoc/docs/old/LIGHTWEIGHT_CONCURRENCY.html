<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
  <meta content="text/html; charset=UTF-8" http-equiv="Content-Type" />

  <title>File: LIGHTWEIGHT_CONCURRENCY [eventmachine-1.2.1 Documentation]</title>

  <link type="text/css" media="screen" href="../../rdoc.css" rel="stylesheet" />

  <script src="../../js/jquery.js" type="text/javascript"
    charset="utf-8"></script>
  <script src="../../js/thickbox-compressed.js" type="text/javascript"
    charset="utf-8"></script>
  <script src="../../js/quicksearch.js" type="text/javascript"
    charset="utf-8"></script>
  <script src="../../js/darkfish.js" type="text/javascript"
    charset="utf-8"></script>
</head>

<body class="file">
  <div id="metadata">
    <div id="home-metadata">
      <div id="home-section" class="section">
        <h3 class="section-header">
          <a href="../../index.html">Home</a>
          <a href="../../index.html#classes">Classes</a>
          <a href="../../index.html#methods">Methods</a>
        </h3>
      </div>
    </div>

    <div id="project-metadata">
      
      
      <div id="fileindex-section" class="section project-section">
        <h3 class="section-header">Files</h3>
        <ul>
        
          <li class="file"><a href="../../docs/old/ChangeLog.html">ChangeLog</a></li>
        
          <li class="file"><a href="../../docs/old/DEFERRABLES.html">DEFERRABLES</a></li>
        
          <li class="file"><a href="../../docs/old/EPOLL.html">EPOLL</a></li>
        
          <li class="file"><a href="../../docs/old/INSTALL.html">INSTALL</a></li>
        
          <li class="file"><a href="../../docs/old/KEYBOARD.html">KEYBOARD</a></li>
        
          <li class="file"><a href="../../docs/old/LEGAL.html">LEGAL</a></li>
        
          <li class="file"><a href="../../docs/old/LIGHTWEIGHT_CONCURRENCY.html">LIGHTWEIGHT_CONCURRENCY</a></li>
        
          <li class="file"><a href="../../docs/old/PURE_RUBY.html">PURE_RUBY</a></li>
        
          <li class="file"><a href="../../docs/old/RELEASE_NOTES.html">RELEASE_NOTES</a></li>
        
          <li class="file"><a href="../../docs/old/SMTP.html">SMTP</a></li>
        
          <li class="file"><a href="../../docs/old/SPAWNED_PROCESSES.html">SPAWNED_PROCESSES</a></li>
        
          <li class="file"><a href="../../docs/old/TODO.html">TODO</a></li>
        
        </ul>
      </div>
      

      <div id="classindex-section" class="section project-section">
        <h3 class="section-header">Class Index
          <span class="search-toggle"><img src="../../images/find.png"
            height="16" width="16" alt="[+]"
            title="show/hide quicksearch" /></span></h3>
        <form action="#" method="get" accept-charset="utf-8" class="initially-hidden">
        <fieldset>
          <legend>Quicksearch</legend>
          <input type="text" name="quicksearch" value=""
            class="quicksearch-field" />
        </fieldset>
        </form>

        <ul class="link-list">
        
          <li><a href="../../EventMachine.html">EventMachine</a></li>
        
          <li><a href="../../EventMachine.html">EventMachine</a></li>
        
          <li><a href="../../EventMachine/CertificateCreator.html">EventMachine::CertificateCreator</a></li>
        
          <li><a href="../../EventMachine/Channel.html">EventMachine::Channel</a></li>
        
          <li><a href="../../EventMachine/Completion.html">EventMachine::Completion</a></li>
        
          <li><a href="../../EventMachine/Connection.html">EventMachine::Connection</a></li>
        
          <li><a href="../../EventMachine/ConnectionError.html">EventMachine::ConnectionError</a></li>
        
          <li><a href="../../EventMachine/ConnectionNotBound.html">EventMachine::ConnectionNotBound</a></li>
        
          <li><a href="../../EventMachine/DNS.html">EventMachine::DNS</a></li>
        
          <li><a href="../../EventMachine/DNS/Request.html">EventMachine::DNS::Request</a></li>
        
          <li><a href="../../EventMachine/DNS/RequestIdAlreadyUsed.html">EventMachine::DNS::RequestIdAlreadyUsed</a></li>
        
          <li><a href="../../EventMachine/DNS/Resolver.html">EventMachine::DNS::Resolver</a></li>
        
          <li><a href="../../EventMachine/DNS/Socket.html">EventMachine::DNS::Socket</a></li>
        
          <li><a href="../../EventMachine/DatagramObject.html">EventMachine::DatagramObject</a></li>
        
          <li><a href="../../EventMachine/DefaultDeferrable.html">EventMachine::DefaultDeferrable</a></li>
        
          <li><a href="../../EventMachine/Deferrable.html">EventMachine::Deferrable</a></li>
        
          <li><a href="../../EventMachine/DeferrableChildProcess.html">EventMachine::DeferrableChildProcess</a></li>
        
          <li><a href="../../EventMachine/Error.html">EventMachine::Error</a></li>
        
          <li><a href="../../EventMachine/EvmaKeyboard.html">EventMachine::EvmaKeyboard</a></li>
        
          <li><a href="../../EventMachine/EvmaTCPClient.html">EventMachine::EvmaTCPClient</a></li>
        
          <li><a href="../../EventMachine/EvmaTCPServer.html">EventMachine::EvmaTCPServer</a></li>
        
          <li><a href="../../EventMachine/EvmaUDPSocket.html">EventMachine::EvmaUDPSocket</a></li>
        
          <li><a href="../../EventMachine/EvmaUNIXClient.html">EventMachine::EvmaUNIXClient</a></li>
        
          <li><a href="../../EventMachine/EvmaUNIXServer.html">EventMachine::EvmaUNIXServer</a></li>
        
          <li><a href="../../EventMachine/FileNotFoundException.html">EventMachine::FileNotFoundException</a></li>
        
          <li><a href="../../EventMachine/FileStreamer.html">EventMachine::FileStreamer</a></li>
        
          <li><a href="../../EventMachine/FileWatch.html">EventMachine::FileWatch</a></li>
        
          <li><a href="../../EventMachine/Iterator.html">EventMachine::Iterator</a></li>
        
          <li><a href="../../EventMachine/LoopbreakReader.html">EventMachine::LoopbreakReader</a></li>
        
          <li><a href="../../EventMachine/PeriodicTimer.html">EventMachine::PeriodicTimer</a></li>
        
          <li><a href="../../EventMachine/Pool.html">EventMachine::Pool</a></li>
        
          <li><a href="../../EventMachine/ProcessWatch.html">EventMachine::ProcessWatch</a></li>
        
          <li><a href="../../EventMachine/Protocols.html">EventMachine::Protocols</a></li>
        
          <li><a href="../../EventMachine/Protocols.html">EventMachine::Protocols</a></li>
        
          <li><a href="../../EventMachine/Protocols/HeaderAndContentProtocol.html">EventMachine::Protocols::HeaderAndContentProtocol</a></li>
        
          <li><a href="../../EventMachine/Protocols/HttpClient.html">EventMachine::Protocols::HttpClient</a></li>
        
          <li><a href="../../EventMachine/Protocols/HttpClient2.html">EventMachine::Protocols::HttpClient2</a></li>
        
          <li><a href="../../EventMachine/Protocols/HttpClient2/Request.html">EventMachine::Protocols::HttpClient2::Request</a></li>
        
          <li><a href="../../EventMachine/Protocols/LineAndTextProtocol.html">EventMachine::Protocols::LineAndTextProtocol</a></li>
        
          <li><a href="../../EventMachine/Protocols/LineProtocol.html">EventMachine::Protocols::LineProtocol</a></li>
        
          <li><a href="../../EventMachine/Protocols/LineText2.html">EventMachine::Protocols::LineText2</a></li>
        
          <li><a href="../../EventMachine/Protocols/Memcache.html">EventMachine::Protocols::Memcache</a></li>
        
          <li><a href="../../EventMachine/Protocols/Memcache/ParserError.html">EventMachine::Protocols::Memcache::ParserError</a></li>
        
          <li><a href="../../EventMachine/Protocols/ObjectProtocol.html">EventMachine::Protocols::ObjectProtocol</a></li>
        
          <li><a href="../../EventMachine/Protocols/Postgres3.html">EventMachine::Protocols::Postgres3</a></li>
        
          <li><a href="../../EventMachine/Protocols/SASLauth.html">EventMachine::Protocols::SASLauth</a></li>
        
          <li><a href="../../EventMachine/Protocols/SASLauthclient.html">EventMachine::Protocols::SASLauthclient</a></li>
        
          <li><a href="../../EventMachine/Protocols/SmtpClient.html">EventMachine::Protocols::SmtpClient</a></li>
        
          <li><a href="../../EventMachine/Protocols/SmtpServer.html">EventMachine::Protocols::SmtpServer</a></li>
        
          <li><a href="../../EventMachine/Protocols/Socks4.html">EventMachine::Protocols::Socks4</a></li>
        
          <li><a href="../../EventMachine/Protocols/Stomp.html">EventMachine::Protocols::Stomp</a></li>
        
          <li><a href="../../EventMachine/Protocols/Stomp/Message.html">EventMachine::Protocols::Stomp::Message</a></li>
        
          <li><a href="../../EventMachine/Protocols/TcpConnectTester.html">EventMachine::Protocols::TcpConnectTester</a></li>
        
          <li><a href="../../EventMachine/Queue.html">EventMachine::Queue</a></li>
        
          <li><a href="../../EventMachine/Reactor.html">EventMachine::Reactor</a></li>
        
          <li><a href="../../EventMachine/Selectable.html">EventMachine::Selectable</a></li>
        
          <li><a href="../../EventMachine/SpawnedProcess.html">EventMachine::SpawnedProcess</a></li>
        
          <li><a href="../../EventMachine/StreamObject.html">EventMachine::StreamObject</a></li>
        
          <li><a href="../../EventMachine/SystemCmd.html">EventMachine::SystemCmd</a></li>
        
          <li><a href="../../EventMachine/ThreadedResource.html">EventMachine::ThreadedResource</a></li>
        
          <li><a href="../../EventMachine/TickLoop.html">EventMachine::TickLoop</a></li>
        
          <li><a href="../../EventMachine/Timer.html">EventMachine::Timer</a></li>
        
          <li><a href="../../EventMachine/UnknownTimerFired.html">EventMachine::UnknownTimerFired</a></li>
        
          <li><a href="../../EventMachine/Unsupported.html">EventMachine::Unsupported</a></li>
        
          <li><a href="../../EventMachine/UuidGenerator.html">EventMachine::UuidGenerator</a></li>
        
          <li><a href="../../EventMachine/YieldBlockFromSpawnedProcess.html">EventMachine::YieldBlockFromSpawnedProcess</a></li>
        
          <li><a href="../../Object.html">Object</a></li>
        
          <li><a href="../../EventMachine.html">Object::EM</a></li>
        
          <li><a href="../../EventMachine/Protocols.html">Object::P</a></li>
        
          <li><a href="../../BufferedTokenizer.html">BufferedTokenizer</a></li>
        
          <li><a href="../../IO.html">IO</a></li>
        
          <li><a href="../../StringIO.html">StringIO</a></li>
        
          <li><a href="../../TestConnection.html">TestConnection</a></li>
        
        </ul>
        <div id="no-class-search-results" style="display: none;">No matching classes.</div>
      </div>

      
    </div>
  </div>

  <div id="documentation">
    
<p><a href="../../EventMachine.html">EventMachine</a> (<a
href="../../EventMachine.html">EM</a>) adds two different formalisms for
lightweight concurrency to the Ruby programmer's toolbox: spawned processes
and deferrables. This note will show you how to use them.</p>

<h3>What is Lightweight Concurrency?</h3>

<p>We use the term “Lightweight Concurrency” (LC) to refer to concurrency
mechanisms that are lighter than Ruby threads. By “lighter,” we mean: less
resource-intensive in one or more dimensions, usually including memory and
CPU usage. In general, you turn to LC in the hope of improving the
performance and scalability of your programs.</p>

<p>In addition to the two <a href="../../EventMachine.html">EventMachine</a>
mechanisms we will discuss here, Ruby has at least one other LC construct:
Fibers, which are currently under development in Ruby 1.9.</p>

<p>The technical feature that makes all of these LC mechanisms different from
standard Ruby threads is that they are not scheduled automatically.</p>

<p>When you create and run Ruby threads, you can assume (within certain
constraints) that your threads will all be scheduled fairly by Ruby’s
runtime. Ruby itself is responsible for giving each of your threads its own
share of the total runtime.</p>

<p>But with LC, your program is responsible for causing different execution
paths to run. In effect, your program has to act as a “thread scheduler.”
Scheduled entities in LC run to completion and are never preempted. The
runtime system has far less work to do since it has no need to interrupt
threads or to schedule them fairly. This is what makes LC lighter and
faster.</p>

<p>You’ll learn exactly how LC scheduling works in practice as we work through
specific examples.</p>

<h3><a href="../../EventMachine.html">EventMachine</a> Lightweight Concurrency</h3>

<p>Recall that <a href="../../EventMachine.html">EM</a> provides a reactor
loop that must be running in order for your programs to perform
event-driven logic. An <a href="../../EventMachine.html">EM</a> program
typically has a structure like this:</p>

<pre>require 'eventmachine'

# your initializations

EM.run {
    # perform event-driven I/O here, including network clients,
    # servers, timers, and thread-pool operations.
}

# your cleanup
# end of the program</pre>

<p>EventMachine#run executes the reactor loop, which causes your code to be
called as events of interest to your program occur. The block you pass to
EventMachine#run is executed right after the reactor loop starts, and is
the right place to start socket acceptors, etc.</p>

<p>Because the reactor loop runs constantly in an <a
href="../../EventMachine.html">EM</a> program (until it is stopped by a
call to EventMachine#stop), it has the ability to schedule blocks of code
for asynchronous execution. Unlike a pre-emptive thread scheduler, it’s NOT
able to interrupt code blocks while they execute. But the scheduling
capability it does have is enough to enable lightweight concurrency.</p>

<p>For information on Spawned Processes, see the separate document
SPAWNED_PROCESSES.</p>

<p>For information on Deferrables, see the separate document DEFERRABLES.</p>

<h3>[SIDEBAR]: I Heard That <a href="../../EventMachine.html">EventMachine</a> Doesn’t Work With Ruby Threads.</h3>

<p>This is incorrect. <a href="../../EventMachine.html">EM</a> is fully
interoperable with all versions of Ruby threads, and has been since its
earliest releases.</p>

<p>It’s very true that <a href="../../EventMachine.html">EM</a> encourages an
“evented” (non-threaded) programming style. The specific benefits of
event-driven programming are far better performance and scalability for
well-written programs, and far easier debugging.</p>

<p>The benefit of using threads for similar applications is a possibly more
intuitive programming model, as well as the fact that threads are already
familiar to most programmers. Also, bugs in threaded programs often fail to
show up until programs go into production. These factors create the
illusion that threaded programs are easier to write.</p>

<p>However, some operations that occur frequently in professional-caliber
applications simply can’t be done without threads. (The classic example is
making calls to database client-libraries that block on network I/O until
they complete.)</p>

<p><a href="../../EventMachine.html">EventMachine</a> not only allows the use
of Ruby threads in these cases, but it even provides a built-in thread-pool
object to make them easier to work with.</p>

<p>You may have heard a persistent criticism that evented I/O is fundamentally
incompatible with Ruby threads. It is true that some well-publicized
attempts to incorporate event-handling libraries into Ruby were not
successful. But <a href="../../EventMachine.html">EventMachine</a> was
designed from the ground up with Ruby compatibility in mind, so <a
href="../../EventMachine.html">EM</a> never suffered from the problems that
defeated the earlier attempts.</p>

<h3>[SIDEBAR]: I Heard That <a href="../../EventMachine.html">EventMachine</a> Doesn’t Work Very Well On Windows.</h3>

<p>This too is incorrect. <a href="../../EventMachine.html">EventMachine</a>
is an extension written in C++ and Java, and therefore it requires
compilation. Many Windows computers (and some Unix computers, especially in
production environments) don’t have a build stack. Attempting to install <a
href="../../EventMachine.html">EventMachine</a> on a machine without a
compiler usually produces a confusing error.</p>

<p>In addition, Ruby has a much-debated issue with Windows compiler versions.
Ruby on Windows works best with Visual Studio 6, a compiler version that is
long out-of-print, no longer supported by Microsoft, and difficult to
obtain. (This problem is not specific to <a
href="../../EventMachine.html">EventMachine</a>.)</p>

<p>Shortly after <a href="../../EventMachine.html">EventMachine</a> was first
released, the compiler issues led to criticism that <a
href="../../EventMachine.html">EM</a> was incompatible with Windows. Since
that time, every <a href="../../EventMachine.html">EventMachine</a> release
has been supplied in a precompiled binary form for Windows users, that does
not require you to compile the code yourself. <a
href="../../EventMachine.html">EM</a> binary Gems for Windows are compiled
using Visual Studio 6.</p>

<p><a href="../../EventMachine.html">EventMachine</a> does supply some
advanced features (such as Linux EPOLL support, reduced-privilege
operation, UNIX-domain sockets, etc.) that have no meaningful
implementation on Windows. Apart from these special cases, all <a
href="../../EventMachine.html">EM</a> functionality (including lightweight
concurrency) works perfectly well on Windows.</p>

  </div>

  <div id="validator-badges">
    <p><small><a href="http://validator.w3.org/check/referer">[Validate]</a></small></p>
    <p><small>Generated with the <a href="http://deveiate.org/projects/Darkfish-Rdoc/">Darkfish
      Rdoc Generator</a> 2</small>.</p>
  </div>
</body>
</html>

